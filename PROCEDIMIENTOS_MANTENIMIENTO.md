# üîß Procedimientos de Mantenimiento

## üè• Sistema Predictivo de Diabetes Mellitus Tipo 2

Este documento describe los procedimientos completos de mantenimiento para el sistema en producci√≥n, incluyendo monitoreo, actualizaciones, backups, y resoluci√≥n de problemas.

---

## üìã Resumen de Mantenimiento

### üîÑ Frecuencia de Actividades:

| Actividad | Frecuencia | Responsable | Criticidad |
|-----------|------------|-------------|------------|
| Health Checks | Cada 5 min | Sistema | Cr√≠tica |
| Monitoreo Logs | Continua | Equipo DevOps | Alta |
| Backup Modelos | Diario | Sistema | Alta |
| Actualizaci√≥n Dependencias | Mensual | Equipo Dev | Media |
| Revisi√≥n Seguridad | Trimestral | Equipo Seguridad | Alta |
| Auditor√≠a Rendimiento | Semestral | Equipo DevOps | Media |

### üè• Servicios a Mantener:
- ‚úÖ **API REST** (`diabetes-api`) - Puerto 8002
- ‚úÖ **Streamlit Dashboard** (`diabetes-streamlit`) - Puerto 8501
- ‚úÖ **MLflow UI** (`diabetes-mlflow`) - Puerto 5000
- ‚úÖ **PostgreSQL Database** (`diabetes-db`) - Puerto 5432

---

## üè• Monitoreo del Sistema

### Health Checks Autom√°ticos

#### 1. Health Check API
```bash
# Comando
curl -s https://diabetes-api-xxxx.onrender.com/health | jq '.'

# Respuesta esperada
{
  "status": "healthy",
  "timestamp": "2025-09-23T00:57:26.481Z",
  "version": "2.0.0",
  "model_loaded": true,
  "total_predictions": 150
}
```

#### 2. Health Check Streamlit
```bash
# Comando
curl -f -I https://diabetes-streamlit-xxxx.onrender.com/

# Respuesta esperada
HTTP/2 200
content-type: text/html; charset=utf-8
```

#### 3. Health Check MLflow
```bash
# Comando
curl -f -I https://diabetes-mlflow-xxxx.onrender.com/

# Respuesta esperada
HTTP/2 200
```

### M√©tricas Cr√≠ticas a Monitorear

#### 1. M√©tricas de Rendimiento:
```bash
# Tiempo de respuesta API
curl -o /dev/null -s -w "%{time_total}\n" https://diabetes-api-xxxx.onrender.com/health

# Uso de CPU y Memoria (Render Dashboard)
# - CPU < 80%
# - Memoria < 80%
# - Response Time < 5 segundos
```

#### 2. M√©tricas de Calidad:
```bash
# Tasa de √©xito de predicciones
# - Error Rate < 1%
# - Model Accuracy > 85%
# - Prediction Consistency > 95%
```

#### 3. M√©tricas de Disponibilidad:
```bash
# Uptime del sistema
# - API Availability > 99.5%
# - Dashboard Availability > 99%
# - Database Availability > 99.9%
```

---

## üìä Logs y Alertas

### Configuraci√≥n de Logs

#### 1. Logs de API:
```bash
# Ubicaci√≥n: Render Dashboard > Servicio > Logs
# Contenido:
# - Request/Response logs
# - Error logs
# - Model loading logs
# - Prediction logs
```

#### 2. Logs de Streamlit:
```bash
# Ubicaci√≥n: Render Dashboard > Servicio > Logs
# Contenido:
# - User interactions
# - File upload logs
# - Visualization errors
# - Session management
```

#### 3. Logs de MLflow:
```bash
# Ubicaci√≥n: Render Dashboard > Servicio > Logs
# Contenido:
# - Model tracking
# - Experiment logs
# - UI access logs
```

### Sistema de Alertas

#### 1. Alertas Autom√°ticas en Render:
```bash
# Configurar en Render Dashboard:
# - CPU Usage > 80% (Warning)
# - Memory Usage > 85% (Critical)
# - Response Time > 5s (Warning)
# - Error Rate > 5% (Critical)
# - Service Down (Critical)
```

#### 2. Alertas Personalizadas:
```bash
#!/bin/bash
# Script: alert_system.sh

API_URL="https://diabetes-api-xxxx.onrender.com"

# Verificar health check
if ! curl -f -s "$API_URL/health" > /dev/null; then
    echo "$(date): API DOWN - Enviando alerta" | tee -a /var/log/system_alerts.log
    # Enviar email/SMS
    echo "API del Sistema de Diabetes no responde" | mail -s "CRITICAL: API Down" admin@hospital.com
fi

# Verificar modelo cargado
HEALTH_STATUS=$(curl -s "$API_URL/health" | jq -r '.model_loaded')
if [ "$HEALTH_STATUS" != "true" ]; then
    echo "$(date): Model Not Loaded - Enviando alerta" | tee -a /var/log/system_alerts.log
    echo "Modelo de ML no cargado en API" | mail -s "WARNING: Model Loading Issue" admin@hospital.com
fi
```

---

## üîÑ Actualizaciones del Sistema

### Procedimiento de Actualizaci√≥n

#### 1. Preparaci√≥n:
```bash
# 1. Crear backup del estado actual
git tag "backup-$(date +%Y%m%d-%H%M%S)"

# 2. Crear branch de actualizaci√≥n
git checkout -b "update-$(date +%Y%m%d)"

# 3. Actualizar c√≥digo
# - Revisar cambios necesarios
# - Actualizar dependencias si es requerido
# - Probar cambios localmente
```

#### 2. Deploy:
```bash
# 1. Commit de cambios
git add .
git commit -m "Actualizaci√≥n del sistema - $(date)"

# 2. Push a GitHub
git push origin main

# 3. Render detectar√° autom√°ticamente y har√° deploy
# - Monitorear logs de deploy
# - Verificar health checks despu√©s del deploy
```

#### 3. Verificaci√≥n Post-Deploy:
```bash
# 1. Verificar servicios
curl -f https://diabetes-api-xxxx.onrender.com/health
curl -f -I https://diabetes-streamlit-xxxx.onrender.com/
curl -f -I https://diabetes-mlflow-xxxx.onrender.com/

# 2. Probar funcionalidad
curl -X POST https://diabetes-api-xxxx.onrender.com/predict \
  -H "Content-Type: application/json" \
  -d '{"edad": 45, "sexo": "M", "imc": 25.5, ...}'

# 3. Verificar logs por errores
```

#### 4. Rollback (si es necesario):
```bash
# 1. Revertir en GitHub
git revert HEAD
git push origin main

# 2. O deploy del tag de backup
git checkout "backup-$(date +%Y%m%d-%H%M%S)"
git push origin main
```

---

## üíæ Backups y Recuperaci√≥n

### Estrategia de Backups

#### 1. Backups Autom√°ticos (Render):
```bash
# PostgreSQL:
# - Snapshots diarios autom√°ticos (Render)
# - Retenci√≥n: 7 d√≠as
# - Ubicaci√≥n: Render Dashboard > Database > Backups

# Modelos de ML:
# - Versionados en Git
# - Backup en MLflow
# - Retenci√≥n: Permanente
```

#### 2. Backup Manual de Modelos:
```bash
#!/bin/bash
# Script: backup_models.sh

BACKUP_DIR="/app/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Crear directorio de backup
mkdir -p "$BACKUP_DIR/$TIMESTAMP"

# Backup modelos
cp -r /app/models/* "$BACKUP_DIR/$TIMESTAMP/"
cp -r /app/mlruns/* "$BACKUP_DIR/$TIMESTAMP/"

# Backup configuraci√≥n
cp /app/requirements.txt "$BACKUP_DIR/$TIMESTAMP/"
cp /app/config.py "$BACKUP_DIR/$TIMESTAMP/"

# Comprimir
cd "$BACKUP_DIR"
tar -czf "backup_$TIMESTAMP.tar.gz" "$TIMESTAMP/"

# Limpiar backups antiguos (mantener 7 d√≠as)
find "$BACKUP_DIR" -name "backup_*.tar.gz" -mtime +7 -delete

echo "Backup completado: $BACKUP_DIR/backup_$TIMESTAMP.tar.gz"
```

#### 3. Recuperaci√≥n de Backup:
```bash
#!/bin/bash
# Script: restore_backup.sh

BACKUP_FILE="/app/backups/backup_20250923_120000.tar.gz"

# Extraer backup
cd /app
tar -xzf "$BACKUP_FILE"

# Restaurar modelos
cp -r /app/20250923_120000/models/* /app/models/
cp -r /app/20250923_120000/mlruns/* /app/mlruns/

# Reiniciar servicios
# (Render lo har√° autom√°ticamente con el pr√≥ximo deploy)

echo "Restauraci√≥n completada desde: $BACKUP_FILE"
```

---

## üîß Mantenimiento de Base de Datos

### Optimizaci√≥n de PostgreSQL

#### 1. Monitoreo de Base de Datos:
```bash
# Verificar conexiones activas
# - M√°ximo 10 conexiones simult√°neas
# - Sin conexiones idle por mucho tiempo

# Verificar tama√±o de tablas
# - Logs table < 1GB
# - Predictions table < 5GB

# Verificar √≠ndices
# - √çndices en columnas de b√∫squeda
# - √çndices optimizados
```

#### 2. Limpieza de Datos:
```bash
#!/bin/bash
# Script: clean_database.sh

# Eliminar logs antiguos (> 30 d√≠as)
# Eliminar predicciones an√≥nimas (> 90 d√≠as)
# Optimizar tablas
# Recrear √≠ndices si es necesario

echo "Limpieza de base de datos completada"
```

#### 3. Backup de Base de Datos:
```bash
# Render hace backups autom√°ticos
# Para backup manual:
pg_dump $DATABASE_URL > diabetes_backup_$(date +%Y%m%d).sql

# Para restaurar:
psql $DATABASE_URL < diabetes_backup_20250923.sql
```

---

## ü§ñ Mantenimiento de Modelos de ML

### Actualizaci√≥n de Modelos

#### 1. Entrenamiento de Nuevos Modelos:
```bash
# 1. Preparar nuevos datos
python data_generator.py --n_samples 10000

# 2. Entrenar modelos
python model_trainer.py --experiment_name "Production_Update"

# 3. Evaluar rendimiento
python test_models.py --model_path models/new_model.joblib

# 4. Si es mejor, reemplazar modelo actual
cp models/new_model.joblib models/best_model.joblib
```

#### 2. Validaci√≥n de Modelos:
```bash
# 1. Verificar m√©tricas
python -c "
from predictor import DiabetesPredictor
p = DiabetesPredictor()
info = p.get_model_info()
print(f'R2 Score: {info[\"r2_score\"]}')
print(f'Features: {info[\"n_features\"]}')
"

# 2. Probar con datos conocidos
# - Usar dataset de validaci√≥n
# - Verificar consistencia de predicciones
# - Validar categor√≠as de salida
```

#### 3. Deploy de Nuevos Modelos:
```bash
# 1. Subir modelo a repositorio
git add models/new_model.joblib
git commit -m "Nuevo modelo de producci√≥n - $(date)"
git push origin main

# 2. Render har√° deploy autom√°tico
# 3. Verificar que el modelo cargue correctamente
curl -s https://diabetes-api-xxxx.onrender.com/model/info | jq '.'
```

---

## üîí Mantenimiento de Seguridad

### Actualizaciones de Seguridad

#### 1. Dependencias:
```bash
# Verificar vulnerabilidades
pip install safety
safety check

# Actualizar dependencias cr√≠ticas
pip install --upgrade fastapi uvicorn streamlit

# Verificar despu√©s de actualizaci√≥n
safety check
```

#### 2. Configuraci√≥n de Seguridad:
```bash
# Verificar variables de entorno
# - SECRET_KEY configurada
# - JWT_SECRET_KEY configurada
# - No credenciales en c√≥digo

# Verificar CORS
# - Solo dominios autorizados
# - Headers de seguridad

# Verificar HTTPS
# - Certificados v√°lidos
# - Redirecci√≥n HTTP -> HTTPS
```

#### 3. Auditor√≠a de Seguridad:
```bash
# Revisar logs de acceso
# - IPs sospechosas
# - Intentos de acceso no autorizado
# - Patrones de uso inusuales

# Verificar permisos
# - Archivos con permisos correctos
# - Variables de entorno seguras
```

---

## üìà Optimizaci√≥n de Rendimiento

### Monitoreo de Rendimiento

#### 1. M√©tricas de API:
```bash
# Tiempo de respuesta
curl -o /dev/null -s -w "Response Time: %{time_total}s\n" \
  https://diabetes-api-xxxx.onrender.com/health

# Throughput
# - Predicciones por minuto
# - Requests por segundo
```

#### 2. Uso de Recursos:
```bash
# CPU y Memoria (Render Dashboard)
# - Promedio < 70%
# - Picos < 90%

# Base de datos
# - Conexiones < 10
# - Queries lentas < 1%
```

#### 3. Optimizaciones:
```bash
# Si hay problemas de rendimiento:

# 1. Optimizar carga de modelos
# - Lazy loading
# - Model caching

# 2. Optimizar consultas DB
# - √çndices apropiados
# - Queries eficientes

# 3. Escalar recursos si es necesario
# - Aumentar CPU/Memoria en Render
# - Optimizar configuraci√≥n
```

---

## üö® Resoluci√≥n de Problemas

### Procedimiento de Troubleshooting

#### 1. Identificar el Problema:
```bash
# 1. Verificar health checks
curl -s https://diabetes-api-xxxx.onrender.com/health | jq '.'

# 2. Revisar logs recientes
# - Render Dashboard > Logs
# - Buscar errores

# 3. Verificar m√©tricas
# - CPU/Memoria
# - Response times
```

#### 2. Problemas Comunes y Soluciones:

**API no responde:**
```bash
# 1. Verificar si el servicio est√° corriendo
curl -f -I https://diabetes-api-xxxx.onrender.com/health

# 2. Revisar logs por errores de startup
# 3. Verificar variables de entorno
# 4. Reiniciar servicio si es necesario
```

**Modelo no carga:**
```bash
# 1. Verificar que el modelo existe
ls -la models/

# 2. Verificar integridad del archivo
file models/best_model.joblib

# 3. Revisar logs de carga del modelo
# 4. Re-entrenar modelo si es necesario
```

**Base de datos no conecta:**
```bash
# 1. Verificar variables de entorno
echo $DATABASE_URL

# 2. Probar conexi√≥n manual
psql $DATABASE_URL -c "SELECT 1;"

# 3. Verificar estado del servicio de BD
# 4. Revisar logs de conexi√≥n
```

**Rendimiento lento:**
```bash
# 1. Verificar uso de recursos
# 2. Identificar bottlenecks
# 3. Optimizar queries lentas
# 4. Considerar escalado
```

#### 3. Escalaci√≥n de Problemas:
```bash
# Si no se puede resolver:

# 1. Documentar el problema
# - S√≠ntomas
# - Pasos para reproducir
# - Logs relevantes

# 2. Notificar al equipo
# - Equipo de desarrollo
# - Equipo de DevOps
# - Stakeholders

# 3. Implementar soluci√≥n temporal
# - Workaround
# - Rollback si es necesario
```

---

## üìã Checklist de Mantenimiento

### Mantenimiento Diario:
- [ ] ‚úÖ Health checks funcionando
- [ ] ‚úÖ Logs revisados por errores
- [ ] ‚úÖ M√©tricas de rendimiento revisadas
- [ ] ‚úÖ Backups autom√°ticos verificados

### Mantenimiento Semanal:
- [ ] ‚úÖ Pruebas de funcionalidad completas
- [ ] ‚úÖ Revisi√≥n de logs de seguridad
- [ ] ‚úÖ Optimizaci√≥n de consultas DB
- [ ] ‚úÖ Verificaci√≥n de modelos

### Mantenimiento Mensual:
- [ ] ‚úÖ Actualizaci√≥n de dependencias
- [ ] ‚úÖ Revisi√≥n de configuraci√≥n
- [ ] ‚úÖ Pruebas de carga
- [ ] ‚úÖ Auditor√≠a de seguridad

### Mantenimiento Trimestral:
- [ ] ‚úÖ Revisi√≥n completa del sistema
- [ ] ‚úÖ Actualizaci√≥n de modelos si es necesario
- [ ] ‚úÖ Optimizaci√≥n de rendimiento
- [ ] ‚úÖ Planificaci√≥n de mejoras

---

## üìû Contactos y Soporte

### Equipo de Mantenimiento:
- **DevOps:** devops@hospital.com
- **Desarrollo:** desarrollo@sistemadiabetes.com
- **Seguridad:** seguridad@hospital.com
- **Soporte:** soporte@sistemadiabetes.com

### Recursos de Soporte:
- üìö Documentaci√≥n: `/docs` en API
- üîÑ Estado del Sistema: `/health` endpoint
- üìä M√©tricas: Render Dashboard
- üêõ Reportes: GitHub Issues

### Niveles de Severidad:
- üî¥ **Cr√≠tico:** Sistema no funcional - Respuesta inmediata
- üü° **Alto:** Funcionalidad afectada - Respuesta en 2 horas
- üü¢ **Medio:** Problema menor - Respuesta en 24 horas
- üîµ **Bajo:** Mejora o consulta - Respuesta en 1 semana

---

## üìà Mejoras Continuas

### M√©tricas de Mantenimiento:
```bash
# Tiempo promedio de resoluci√≥n
# - Incidentes cr√≠ticos: < 1 hora
# - Incidentes altos: < 4 horas
# - Incidentes medios: < 24 horas

# Disponibilidad del sistema
# - Uptime > 99.5%
# - MTTR < 2 horas
# - MTBF > 30 d√≠as
```

### Plan de Mejoras:
```bash
# Pr√≥ximas mejoras:
# - Automatizaci√≥n de backups
# - Monitoreo avanzado
# - CI/CD mejorado
# - Documentaci√≥n actualizada
# - Entrenamiento del equipo
```

---

**üìÖ √öltima actualizaci√≥n:** Septiembre 2025
**üè• Versi√≥n del Sistema:** 2.0.0
**‚úÖ Estado de Mantenimiento:** Operativo